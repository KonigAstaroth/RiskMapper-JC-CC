{% extends 'allTemplate.html' %}
{% load static %}

{% block titulo %}
Inicio
{% endblock %}

{% block links %}
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
{% endblock %}

{% block contenido %}
  <div id="map" class="map"></div>




  <script id="marcadores-json" type="application/json">
      {{ markers|safe }}
  </script>

  <script id="map_config_json" type="application/json">
      {{ map_config_json|safe }}
  </script>

  <script  
    src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap&libraries=marker" 
    async 
    defer
  >
  </script>

  <script>
      const iconos = {
        amenazas:"{% static 'mapIcons/enfado.png' %}",
        chapitos:"{% static 'mapIcons/chapitos.png' %}",
        mayos:"{% static 'mapIcons/mayos.png' %}",
        robonegocio: "{% static 'mapIcons/delito.png' %}",
        homicidiodoloso: "{% static 'mapIcons/escena-del-crimen.png' %}",
        feminicidio: "{% static 'mapIcons/stop-violence.png' %}",
        secuestro: "{% static 'mapIcons/tied.png' %}",
        tratapersonas: "{% static 'mapIcons/human-trafficking.png' %}",
        robotranseunte: "{% static 'mapIcons/rob.png' %}",
        extorsion: "{% static 'mapIcons/blackmail.png' %}",
        robocasa: "{% static 'mapIcons/thief.png' %}",
        violacion: "{% static 'mapIcons/security.png' %}",
        narcomenudeo: "{% static 'mapIcons/narcotics.png' %}",
        bajoimpacto: "{% static 'mapIcons/esposas.png' %}",
        robovehiculo: "{% static 'mapIcons/robovehiculo.png' %}",
        armafuego: "{% static 'mapIcons/pistol.png' %}",
        robotransportista: "{% static 'mapIcons/robotransportista.png' %}",
        robotaxi: "{% static 'mapIcons/robotaxi.png' %}",
        roborepartidor: "{% static 'mapIcons/roborepartidor.png' %}",
        robomicrobus: "{% static 'mapIcons/robomicrobus.png' %}",
        robometro: "{% static 'mapIcons/robometro.png' %}",
        nodelito: "{% static 'mapIcons/nodelito.png' %}",
        default: "{% static 'mapIcons/default.png' %}"
      }

          
      async function initMap() {
        const { Map } = await google.maps.importLibrary('maps');
        const { AdvancedMarkerElement, CollisionBehavior } = await google.maps.importLibrary('marker');

        const marcadores = JSON.parse(document.getElementById('marcadores-json').textContent);
        const config = JSON.parse(document.getElementById('map_config_json').textContent);

        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: config.zoom,
            center: config.center,
            mapId: "map"
        });

        console.log("Config", config)

        const infoWindow = new google.maps.InfoWindow();
        const geocoder = new google.maps.Geocoder();

        marcadores.forEach((marcador) => {
            let iconoUrl = iconos[marcador.icono];
            if (!iconoUrl || iconoUrl.trim() == ""){
                iconoUrl = iconos['default']
            }
            const iconImg = document.createElement('img');
            iconImg.src = iconoUrl;
            iconImg.width = 40;
            iconImg.height = 40;

            if (marcador.lat == null || marcador.lng == null) {
                let direccion = `${marcador.calle || ''}, ${marcador.colonia || ''}, ${marcador.municipio || ''}, ${marcador.estado || ''}`;
                direccion = direccion.replace(/&/g, 'y').trim();

                if (!direccion.replace(/[, ]/g, '').length) {
                    return;
                }

                geocoder.geocode({ address: direccion }, (results, status) => {
                    if (status === 'OK') {
                        const latlng = results[0].geometry.location;

                        const marker = new AdvancedMarkerElement({
                            position: latlng,
                            map: map,
                            title: marcador.Categoria || 'Sin categoría',
                            content: iconImg,
                            collisionBehavior: CollisionBehavior.OPTIONAL_AND_HIDES_LOWER_PRIORITY
                        });

                        marker.addListener('gmp-click', () => {
                            infoWindow.setContent(`
                    <h4> Categoría: ${marcador.Categoria || 'Sin categoría'}</h4>
                    <br><p> <b>Calle:</b> ${marcador.calle || 'Desconocido'}, <b>Colonia:</b> ${marcador.colonia || 'Desconocido'} </p>
                    <p> <b>Estado:</b> ${marcador.estado || 'Desconocido'}, <b>Municipio:</b> ${marcador.municipio || 'Desconocido'}</p>
                    <p> <b>Delito:</b> ${marcador.delito || 'Desconocido'}</p>
                    <p> <b>Fecha:</b> ${marcador.fecha || 'No disponible'}</p>
                    <h6>Descripción</h6>
                    <p>${marcador.descripcion || 'Sin descripción'}</p>
                `);
                            infoWindow.setPosition(latlng);
                            infoWindow.open(map);
                        });
                    } else {
                        console.error("Geocoding falló:", status, direccion);
                    }
                });
            } else {
                const position = {
                    lat: Number(marcador.lat),
                    lng: Number(marcador.lng)
                };

                const marker = new AdvancedMarkerElement({
                    position: position,
                    map: map,
                    title: marcador.Categoria || 'Sin categoría',
                    content: iconImg,
                    collisionBehavior: CollisionBehavior.OPTIONAL_AND_HIDES_LOWER_PRIORITY
                });

                marker.addListener('gmp-click', () => {
                    infoWindow.setContent(`
                    <h4> Categoría: ${marcador.Categoria || 'Sin categoría'}</h4>
                    <br><p> <b>Calle:</b> ${marcador.calle || 'Desconocido'}, <b>Colonia:</b> ${marcador.colonia || 'Desconocido'} </p>
                    <p> <b>Estado:</b> ${marcador.estado || 'Desconocido'}, <b>Municipio:</b> ${marcador.municipio || 'Desconocido'}</p>
                    <p> <b>Delito:</b> ${marcador.delito || 'Desconocido'}</p>
                    <p> <b>Fecha:</b> ${marcador.fecha || 'No disponible'}</p>
                    <h6>Descripción</h6>
                    <p>${marcador.descripcion || 'Sin descripción'}</p>
        `);
                    infoWindow.setPosition(position);
                    infoWindow.open(map);
                });
            }
        });
    }

    window.initMap = initMap;
  </script>
{% endblock %}