{% extends 'allTemplate.html' %}
{% load static %}

{% block titulo %}
Inicio
{% endblock %}

{% block links %}
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
{% endblock %}

{% block contenido %}

    <div class="map-container">
    <div class="report-sidebar hidden">
        <button class="sidebar-tab" >
            <i class="bi bi-caret-left"></i>
        </button>
        <form method="POST">
            <div class="sidebar-content">
                <h1>Generar nuevo reporte</h1>
                <hr>
                {% csrf_token %}
                <div class="date-inputs">
                    <div>
                        <label for="startDate">Fecha de inicio</label>
                        <input id="startDate" class="cbr-text-input" type="date">
                    </div>
                    <div>
                        <label for="endDate">Fecha de fin</label>
                        <input id="endDate" class="cbr-text-input" type="date">
                    </div>
                </div>
                <div>
                    <label for="category">Categoría</label>
                    <div class="dropdown">
                        <button id="category-input" class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle = "dropdown" aria-expanded="false" style="background-color: #FFFFFF;color: #838383;font-weight: 400;">
                            Tipos de delito
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <p>Seleccionar máximo 10 categorías de delito</p>
                            </li>
                            {% for delito in lista_delitos %}
                            <li>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" name="delitos" value="{{ delito.valor }}" id="id_delito_{{ forloop.counter }}">
                                    <label for="id_delito_{{ forloop.counter }}" class="form-check-label"> {{ delito.nombre }}</label>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>   
                </div>
                <hr>
                <div class="place-inputs">
                    <label for="state">Estado</label>
                    <input class="cbr-text-input" type="text" name="estado" id="estado">

                    <label for="state">Municipio</label>
                    <input class="cbr-text-input" type="text" name="municipio" id="municipio">
                </div>
                <div class="submit-section">
                    <button class="cbr-submit-button" type="submit" name="buscar" id="buscar">Generar</button>
                </div>
            </div>
        </form>
    </div>
    <div id="map" class="map"></div>
    </div>

    <!-- Modales -->
    <div class="modal fade" data-bs-backdrop="static" id="cbr-loading-modal" aria-hidden="true" aria-labelledby="cbr-loading-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalToggleLabel">Generando reporte</h1>
                </div>
                <div class="modal-body" style="display: flex; justify-content: center;">
                    <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if graphic or calendarios or AiText %}
    <div class="modal fade" data-bs-backdrop="static" id="cbr-confirmation-modal" aria-hidden="true" aria-labelledby="cbr-confirmation-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalToggleLabel">Reporte generado</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div>
                    <b>Zona analizada:</b> {{ lugar }}
                </div>
                Puedes ver el reporte generado o descargarlo desde este mismo recuadro.
            </div>
            <div class="modal-footer">
                <form method="POST" action="{% url 'export' %}">
                    {% csrf_token %}
                    <button class="cbr-button" type="submit" class="send">
                        <i class="bi bi-download"></i>
                        Descargar analisis
                    </button>
                </form>
                <button class="cbr-accent-button" data-bs-target="#cbr-report-modal" data-bs-toggle="modal">
                    Ver analisis
                </button>
            </div>
            </div>
        </div>
    </div>
    <div class="modal fade" data-bs-backdrop="static" id="cbr-report-modal" tabindex="-1" aria-labelledby="cbr-report-modal" aria-hidden="false">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
            <div class="modal-header">
                <h2 class="analisis">ANALISIS DE PATRONES  </h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="carta">
                    <div class="data_analisis">
                        <div style="margin-right: 3%; margin-left: 3%;">
                            <br>
                            <div class="cartaBanner"><h5 style="font-weight: 500;">Zona analizada: {{ lugar }}</h5></div>
                                <div class="calendar-and-graphic-container" style="display: flex; justify-content: space-around; align-items: flex-start; flex-wrap: wrap;">
                                    {% if calendarios %}
                                        <div class="calendars-wrapper" style="flex: 1; min-width: 300px; margin-right: 20px;"> 
                                            {% for cal in calendarios %}
                                                <div>
                                                    <img src="data:image/png;base64,{{ cal.img }}" alt="" class="mb-3" style="max-width: 100%; height: auto;"> 
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                    {% endif %}
                                    
                                    {% if graphic %} 
                                        <div class="graphics-wrapper" style="flex: 1; min-width: 300px;"> 
                                            {% for item in graphic %}
                                                <img src="data:image/png;base64,{{ item.img }}" alt="" style="max-width: 100%; height: auto; margin-bottom: 15px;">
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            <br>
                            {% if graphic and calendarios %}
                                <h3>DATA:</h3>
                                <img src="data:image/png;base64,{{ tabla_base64 }}" alt="">
                                <hr>
                            {% endif %}
                            <h3>Rango horario crítico: </h3><span><p>{{ hour_txt }}</p></span>
                            <h3>Resumen de hechos violentos en el periodo</h3>
                            <div>
                                {{ AiText|safe }}
                            </div>
                            <br>
                        </div>
                    </div>
                </div>                
            </div>
            <div class="modal-footer">
                <button type="button" class="cbr-button" data-bs-target="#cbr-confirmation-modal" data-bs-toggle="modal">Volver</button>
            </div>
            </div>
        </div>
    </div>
    {% else %}
    {% endif %}
    

  <script id="marcadores-json" type="application/json">
      {{ markers|safe }}
  </script>

  <script id="map_config_json" type="application/json">
      {{ map_config_json|safe }}
  </script>

  <script  
    src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap&libraries=marker" 
    async 
    defer
  >
  </script>

  <script>
    const sidebar = document.querySelector(".report-sidebar")
    const sidebarTab = document.querySelector(".sidebar-tab")
    const generateButton = document.getElementById("buscar")

    const loadingModal = new bootstrap.Modal('#cbr-loading-modal')
    const confirmationModal = document.querySelector("#cbr-confirmation-modal") !== null 
    ? new bootstrap.Modal('#cbr-confirmation-modal')
    : null
    
    console.log(sidebarTab)
    sidebarTab.addEventListener("click", () => sidebar.classList.toggle("hidden"))
    generateButton.addEventListener("click", () => loadingModal.show()) 
    if(confirmationModal) { confirmationModal.show() }
  </script>

  <script>
      const iconos = {
        amenazas:"{% static 'mapIcons/enfado.png' %}",
        chapitos:"{% static 'mapIcons/chapitos.png' %}",
        mayos:"{% static 'mapIcons/mayos.png' %}",
        robonegocio: "{% static 'mapIcons/delito.png' %}",
        homicidiodoloso: "{% static 'mapIcons/escena-del-crimen.png' %}",
        feminicidio: "{% static 'mapIcons/stop-violence.png' %}",
        secuestro: "{% static 'mapIcons/tied.png' %}",
        tratapersonas: "{% static 'mapIcons/human-trafficking.png' %}",
        robotranseunte: "{% static 'mapIcons/rob.png' %}",
        extorsion: "{% static 'mapIcons/blackmail.png' %}",
        robocasa: "{% static 'mapIcons/thief.png' %}",
        violacion: "{% static 'mapIcons/security.png' %}",
        narcomenudeo: "{% static 'mapIcons/narcotics.png' %}",
        bajoimpacto: "{% static 'mapIcons/esposas.png' %}",
        robovehiculo: "{% static 'mapIcons/robovehiculo.png' %}",
        armafuego: "{% static 'mapIcons/pistol.png' %}",
        robotransportista: "{% static 'mapIcons/robotransportista.png' %}",
        robotaxi: "{% static 'mapIcons/robotaxi.png' %}",
        roborepartidor: "{% static 'mapIcons/roborepartidor.png' %}",
        robomicrobus: "{% static 'mapIcons/robomicrobus.png' %}",
        robometro: "{% static 'mapIcons/robometro.png' %}",
        nodelito: "{% static 'mapIcons/nodelito.png' %}",
        default: "{% static 'mapIcons/default.png' %}"
      }

          
      async function initMap() {
        const { Map } = await google.maps.importLibrary('maps');
        const { AdvancedMarkerElement, CollisionBehavior } = await google.maps.importLibrary('marker');

        const marcadores = JSON.parse(document.getElementById('marcadores-json').textContent);
        const config = JSON.parse(document.getElementById('map_config_json').textContent);

        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: config.zoom,
            center: config.center,
            mapId: "map"
        });

        console.log("Config", config)

        const infoWindow = new google.maps.InfoWindow();
        const geocoder = new google.maps.Geocoder();

        marcadores.forEach((marcador) => {
            let iconoUrl = iconos[marcador.icono];
            if (!iconoUrl || iconoUrl.trim() == ""){
                iconoUrl = iconos['default']
            }
            const iconImg = document.createElement('img');
            iconImg.src = iconoUrl;
            iconImg.width = 40;
            iconImg.height = 40;

            if (marcador.lat == null || marcador.lng == null) {
                let direccion = `${marcador.calle || ''}, ${marcador.colonia || ''}, ${marcador.municipio || ''}, ${marcador.estado || ''}`;
                direccion = direccion.replace(/&/g, 'y').trim();

                if (!direccion.replace(/[, ]/g, '').length) {
                    return;
                }

                geocoder.geocode({ address: direccion }, (results, status) => {
                    if (status === 'OK') {
                        const latlng = results[0].geometry.location;

                        const marker = new AdvancedMarkerElement({
                            position: latlng,
                            map: map,
                            title: marcador.Categoria || 'Sin categoría',
                            content: iconImg,
                            collisionBehavior: CollisionBehavior.OPTIONAL_AND_HIDES_LOWER_PRIORITY
                        });

                        marker.addListener('gmp-click', () => {
                            infoWindow.setContent(`
                    <h4> Categoría: ${marcador.Categoria || 'Sin categoría'}</h4>
                    <br><p> <b>Calle:</b> ${marcador.calle || 'Desconocido'}, <b>Colonia:</b> ${marcador.colonia || 'Desconocido'} </p>
                    <p> <b>Estado:</b> ${marcador.estado || 'Desconocido'}, <b>Municipio:</b> ${marcador.municipio || 'Desconocido'}</p>
                    <p> <b>Delito:</b> ${marcador.delito || 'Desconocido'}</p>
                    <p> <b>Fecha:</b> ${marcador.fecha || 'No disponible'}</p>
                    <h6>Descripción</h6>
                    <p>${marcador.descripcion || 'Sin descripción'}</p>
                `);
                            infoWindow.setPosition(latlng);
                            infoWindow.open(map);
                        });
                    } else {
                        console.error("Geocoding falló:", status, direccion);
                    }
                });
            } else {
                const position = {
                    lat: Number(marcador.lat),
                    lng: Number(marcador.lng)
                };

                const marker = new AdvancedMarkerElement({
                    position: position,
                    map: map,
                    title: marcador.Categoria || 'Sin categoría',
                    content: iconImg,
                    collisionBehavior: CollisionBehavior.OPTIONAL_AND_HIDES_LOWER_PRIORITY
                });

                marker.addListener('gmp-click', () => {
                    infoWindow.setContent(`
                    <h4> Categoría: ${marcador.Categoria || 'Sin categoría'}</h4>
                    <br><p> <b>Calle:</b> ${marcador.calle || 'Desconocido'}, <b>Colonia:</b> ${marcador.colonia || 'Desconocido'} </p>
                    <p> <b>Estado:</b> ${marcador.estado || 'Desconocido'}, <b>Municipio:</b> ${marcador.municipio || 'Desconocido'}</p>
                    <p> <b>Delito:</b> ${marcador.delito || 'Desconocido'}</p>
                    <p> <b>Fecha:</b> ${marcador.fecha || 'No disponible'}</p>
                    <h6>Descripción</h6>
                    <p>${marcador.descripcion || 'Sin descripción'}</p>
        `);
                    infoWindow.setPosition(position);
                    infoWindow.open(map);
                });
            }
        });
    }

    window.initMap = initMap;
  </script>
{% endblock %}